name : "path_to_purchase" 
query : "WITH campaign_list AS (SELECT advertiser, currency_iso_code, campaign, campaign_id_string, creative, ad_product_type FROM sponsored_ads_traffic GROUP BY advertiser, currency_iso_code, campaign, campaign_id_string, creative, ad_product_type), brand_campaign_lookup as (SELECT MAX(CASE WHEN LOWER(advertiser) LIKE '%allegra%' THEN 'Allegra' WHEN LOWER(creative) LIKE '%allegra%' THEN 'Allegra' WHEN LOWER(campaign) LIKE '%allegra%' THEN 'Allegra' WHEN LOWER(advertiser) LIKE '%aspercreme%' THEN 'Aspercreme' WHEN LOWER(creative) LIKE '%aspercreme%' THEN 'Aspercreme' WHEN LOWER(campaign) LIKE '%aspercreme%' THEN 'Aspercreme' WHEN LOWER(advertiser) LIKE '%cortizone%' THEN 'Cortizone 10' WHEN LOWER(creative) LIKE '%cortizone%' THEN 'Cortizone 10' WHEN LOWER(campaign) LIKE '%cortizone%' THEN 'Cortizone 10' WHEN LOWER(advertiser) LIKE '%dulcolax%' THEN 'Dulcolax' WHEN LOWER(creative) LIKE '%dulcolax%' THEN 'Dulcolax' WHEN LOWER(campaign) LIKE '%dulcolax%' THEN 'Dulcolax' WHEN LOWER(advertiser) LIKE '%gold bond%' THEN 'Gold Bond' WHEN LOWER(creative) LIKE '%gold bond%' THEN 'Gold Bond' WHEN LOWER(campaign) LIKE '%gold bond%' THEN 'Gold Bond' WHEN LOWER(advertiser) LIKE '%icy hot%' THEN 'Icy Hot' WHEN LOWER(creative) LIKE '%icy hot%' THEN 'Icy Hot' WHEN LOWER(campaign) LIKE '%icy hot%' THEN 'Icy Hot' WHEN LOWER(advertiser) LIKE '%nasacort%' THEN 'Nasacort' WHEN LOWER(creative) LIKE '%nasacort%' THEN 'Nasacort' WHEN LOWER(campaign) LIKE '%nasacort%' THEN 'Nasacort' WHEN LOWER(advertiser) LIKE '%selsun blue%' THEN 'Selsun Blue' WHEN LOWER(creative) LIKE '%selsun blue%' THEN 'Selsun Blue' WHEN LOWER(campaign) LIKE '%selsun blue%' THEN 'Selsun Blue' WHEN LOWER(advertiser) LIKE '%unisom%' THEN 'Unisom' WHEN LOWER(creative) LIKE '%unisom%' THEN 'Unisom' WHEN LOWER(campaign) LIKE '%unisom%' THEN 'Unisom' WHEN LOWER(advertiser) LIKE '%xyzal%' THEN 'Xyzal' WHEN LOWER(creative) LIKE '%xyzal%' THEN 'Xyzal' WHEN LOWER(campaign) LIKE '%xyzal%' THEN 'Xyzal' WHEN LOWER(advertiser) LIKE '%zantac%' THEN 'Zantac' WHEN LOWER(creative) LIKE '%zantac%' THEN 'Zantac' WHEN LOWER(campaign) LIKE '%zantac%' THEN 'Zantac' WHEN LOWER(advertiser) LIKE '%pharmaton%' THEN 'Pharmaton' WHEN LOWER(creative) LIKE '%pharmaton%' THEN 'Pharmaton' WHEN LOWER(campaign) LIKE '%pharmaton%' THEN 'Pharmaton' WHEN LOWER(advertiser) LIKE '%initiv%' THEN 'Initiv' WHEN LOWER(creative) LIKE '%initiv%' THEN 'Initiv' WHEN LOWER(campaign) LIKE '%initiv%' THEN 'Initiv' WHEN LOWER(advertiser) LIKE '%dulcosoft%' THEN 'Dulcoease' WHEN LOWER(creative) LIKE '%dulcosoft%' THEN 'Dulcoease' WHEN LOWER(campaign) LIKE '%dulcosoft%' THEN 'Dulcoease' WHEN LOWER(advertiser) LIKE '%pton%' THEN 'PTON' WHEN LOWER(creative) LIKE '%pton%' THEN 'PTON' WHEN LOWER(campaign) LIKE '%pton%' THEN 'PTON' WHEN LOWER(advertiser) LIKE '%bisolherbal%' THEN 'Bisolherbal' WHEN LOWER(creative) LIKE '%bisolherbal%' THEN 'Bisolherbal' WHEN LOWER(campaign) LIKE '%bisolherbal%' THEN 'Bisolherbal' WHEN LOWER(advertiser) LIKE '%buscomint%' THEN 'Buscomint' WHEN LOWER(creative) LIKE '%buscomint%' THEN 'Buscomint' WHEN LOWER(campaign) LIKE '%buscomint%' THEN 'Buscomint' WHEN LOWER(advertiser) LIKE '%allevia%' THEN 'Allevia' WHEN LOWER(creative) LIKE '%allevia%' THEN 'Allevia' WHEN LOWER(campaign) LIKE '%allevia%' THEN 'Allevia' WHEN LOWER(advertiser) LIKE '%buscopan%' THEN 'Buscopan' WHEN LOWER(creative) LIKE '%buscopan%' THEN 'Buscopan' WHEN LOWER(campaign) LIKE '%buscopan%' THEN 'Buscopan' WHEN LOWER(advertiser) LIKE '%dulcoease%' THEN 'Dulcoease' WHEN LOWER(creative) LIKE '%dulcoease%' THEN 'Dulcoease' WHEN LOWER(campaign) LIKE '%dulcoease%' THEN 'Dulcoease' WHEN LOWER(advertiser) LIKE '%act%' THEN 'ACT' WHEN LOWER(creative) LIKE '%act%' THEN 'ACT' WHEN LOWER(campaign) LIKE '%act%' THEN 'ACT' ELSE 'UNCLASSIFIED' END) AS brand, advertiser, currency_iso_code, campaign, campaign_id_string, ad_product_type FROM campaign_list GROUP BY advertiser, currency_iso_code, campaign, campaign_id_string, ad_product_type), sa_data_01 AS (SELECT bcl.brand, bcl.currency_iso_code, sat.campaign, sat.campaign_id_string, CASE WHEN sat.ad_product_type = 'sponsored_products' then 'SP' WHEN sat.ad_product_type = 'sponsored_display' then 'SD' WHEN sat.ad_product_type = 'sponsored_brands' then 'SB' else 'SA_other' end as ad_product_type, sat.user_id, MIN(event_dt) as event_dt_min, sum(spend / 100000000) as spend_sum, sum(impressions) as impressions_sum, sum(clicks) as clicks_sum FROM sponsored_ads_traffic sat INNER JOIN brand_campaign_lookup bcl ON sat.campaign_id_string = bcl.campaign_id_string where user_id is NOT NULL group by 1, 2, 3, 4, 5, 6), amazon_events_data_sa as (SELECT brand, currency_iso_code, aaett.campaign, user_id, aaett.campaign_id_string, sum(detail_page_view) as detail_page_view_sum, sum(brand_halo_detail_page_view) as brand_halo_detail_page_view_sum, sum(total_detail_page_view) as total_detail_page_view_sum, sum(purchases) as purchases_sum, sum(brand_halo_purchases) as brand_halo_purchases_sum, sum(total_purchases) as total_purchases_sum, sum(product_sales) as product_sales_sum, sum(brand_halo_product_sales) as brand_halo_product_sales_sum, sum(total_product_sales) as total_product_sales_sum, sum(units_sold) as units_sold_sum, sum(brand_halo_units_sold) as brand_halo_units_sold_sum, sum(total_units_sold) as total_units_sold_sum, sum(new_to_brand_purchases) as new_to_brand_purchases_sum, sum(new_to_brand_brand_halo_purchases) as new_to_brand_brand_halo_purchases_sum, sum(new_to_brand_total_purchases) as new_to_brand_total_purchases_sum FROM amazon_attributed_events_by_traffic_time aaett INNER JOIN brand_campaign_lookup bcl ON aaett.campaign_id_string = bcl.campaign_id_string where user_id is NOT NULL and aaett.ad_product_type IS NOT NULL group by 1, 2, 3, 4, 5), sa_events as (SELECT sa01.brand, sa01.currency_iso_code, sa01.ad_product_type, sa01.user_id, event_dt_min, sum(spend_sum) as spend_sum, sum(impressions_sum) as impressions_sum, sum(clicks_sum) as clicks_sum, sum(detail_page_view_sum) as detail_page_view_sum, sum(brand_halo_detail_page_view_sum) as brand_halo_detail_page_view_sum, sum(total_detail_page_view_sum) as total_detail_page_view_sum, sum(purchases_sum) as purchases_sum, sum(brand_halo_purchases_sum) as brand_halo_purchases_sum, sum(total_purchases_sum) as total_purchases_sum, sum(product_sales_sum) as product_sales_sum, sum(brand_halo_product_sales_sum) as brand_halo_product_sales_sum, sum(total_product_sales_sum) as total_product_sales_sum, sum(units_sold_sum) as units_sold_sum, sum(brand_halo_units_sold_sum) as brand_halo_units_sold_sum, sum(total_units_sold_sum) as total_units_sold_sum, sum(new_to_brand_purchases_sum) as new_to_brand_purchases_sum, sum(new_to_brand_brand_halo_purchases_sum) as new_to_brand_brand_halo_purchases_sum, sum(new_to_brand_total_purchases_sum) as new_to_brand_total_purchases_sum from sa_data_01 sa01 left join amazon_events_data_sa aes on sa01.brand = aes.brand and sa01.campaign_id_string = aes.campaign_id_string and sa01.user_id = aes.user_id group by 1, 2, 3, 4, 5), combined_dsp_sa as (SELECT brand, currency_iso_code, ad_product_type, user_id, spend_sum, impressions_sum, event_dt_min as impression_dt, clicks_sum, detail_page_view_sum, brand_halo_detail_page_view_sum, total_detail_page_view_sum, purchases_sum, brand_halo_purchases_sum, total_purchases_sum, product_sales_sum, brand_halo_product_sales_sum, total_product_sales_sum, units_sold_sum, brand_halo_units_sold_sum, total_units_sold_sum, new_to_brand_purchases_sum, new_to_brand_brand_halo_purchases_sum, new_to_brand_total_purchases_sum from sa_events), dsp_sa_sorted as (SELECT brand, currency_iso_code, ad_product_type, user_id, MIN(impression_dt) as impression_dt_first, sum(spend_sum) as costs, sum(impressions_sum) as impressions_sum, sum(clicks_sum) as clicks_sum, sum(detail_page_view_sum) as detail_page_view_sum, sum(brand_halo_detail_page_view_sum) as brand_halo_detail_page_view_sum, sum(total_detail_page_view_sum) as total_detail_page_view_sum, sum(purchases_sum) as purchases_sum, sum(brand_halo_purchases_sum) as brand_halo_purchases_sum, sum(total_purchases_sum) as total_purchases_sum, sum(product_sales_sum) as product_sales_sum, sum(brand_halo_product_sales_sum) as brand_halo_product_sales_sum, sum(total_product_sales_sum) as total_product_sales_sum, sum(units_sold_sum) as units_sold_sum, sum(brand_halo_units_sold_sum) as brand_halo_units_sold_sum, sum(total_units_sold_sum) as total_units_sold_sum, sum(new_to_brand_purchases_sum) as new_to_brand_purchases_sum, sum(new_to_brand_brand_halo_purchases_sum) as new_to_brand_brand_halo_purchases_sum, sum(new_to_brand_total_purchases_sum) as new_to_brand_total_purchases_sum from combined_dsp_sa group by 1, 2, 3, 4), ranked AS (SELECT brand, NAMED_ROW('ad_product_order', ROW_NUMBER() OVER(PARTITION BY dss.brand, dss.user_id ORDER BY impression_dt_first), 'ad_product_type', dss.ad_product_type) AS ad_product_order, user_id FROM dsp_sa_sorted dss), assembled_ad_product AS (SELECT brand, ra.user_id, ARRAY_SORT(COLLECT(DISTINCT ra.ad_product_order)) AS ad_product_path FROM ranked ra GROUP BY 1, 2) SELECT BUILT_IN_PARAMETER('TIME_WINDOW_START') as time_window_start, BUILT_IN_PARAMETER('TIME_WINDOW_END') as time_window_end, dspsas.brand, currency_iso_code, ad_product_path, sum(impressions_sum) as impressions_sum, sum(costs) as costs, count(distinct dspsas.user_id) as reach, sum(clicks_sum) as clicks_sum, sum(detail_page_view_sum) as detail_page_view_sum, sum(brand_halo_detail_page_view_sum) as brand_halo_detail_page_view_sum, sum(total_detail_page_view_sum) as total_detail_page_view_sum, sum(purchases_sum) as purchases_sum, sum(brand_halo_purchases_sum) as brand_halo_purchases_sum, sum(total_purchases_sum) as total_purchases_sum, sum(product_sales_sum) as product_sales_sum, sum(brand_halo_product_sales_sum) as brand_halo_product_sales_sum, sum(total_product_sales_sum) as total_product_sales_sum, sum(units_sold_sum) as units_sold_sum, sum(brand_halo_units_sold_sum) as brand_halo_units_sold_sum, sum(total_units_sold_sum) as total_units_sold_sum, sum(new_to_brand_purchases_sum) as new_to_brand_purchases_sum, sum(new_to_brand_brand_halo_purchases_sum) as new_to_brand_brand_halo_purchases_sum, sum(new_to_brand_total_purchases_sum) as new_to_brand_total_purchases_sum from dsp_sa_sorted dspsas join assembled_ad_product aap on dspsas.user_id = aap.user_id and dspsas.brand = aap.brand group by 1, 2, 3, 4, 5"